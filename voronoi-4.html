<!DOCTYPE html>
<meta charset="utf-8">
<style>

.triangles {
  fill: none;
}

.links {
  stroke: rgba(255, 255, 255, 0.11);
  stroke-width: 1px;
}

.sites {
  fill: rgba(255, 0, 200, 0.397);
  stroke: rgba(195, 0, 255, 0.301);

}

.triangles .primary {
  fill: rgba(0, 11, 167, 0.315);
}

.links .primary {
  stroke: rgba(0, 140, 255, 0.562);
}

.sites :first-child {
  fill: rgba(31, 0, 102, 0.76);

  
}
video#bgvid { 
    position: fixed;
    top: 50%;
    left: 50%;
    min-width: 100%;
    min-height: 100%;
    width: auto;
    height: auto;
    z-index: -100;
    -ms-transform: translateX(-50%) translateY(-50%);
    -moz-transform: translateX(-50%) translateY(-50%);
    -webkit-transform: translateX(-50%) translateY(-50%);
    transform: translateX(-50%) translateY(-50%);
    background: url(polina.jpg) no-repeat;
    background-size: cover; 
}
</style>
<video playsinline autoplay muted loop poster="polina.jpg" id="bgvid">
  <source src="sterrenhemel.mp4" type="video/webm">
  <source src="sterrenhemel.mp4" type="video/mp4">
</video>
<div id='level_3'>
    <svg id='svg_3' width="1920" height="300"></svg>
</div>
<div id='level_2'>
    <svg id='svg_2' width="1920" height="300"></svg>
</div>
<div id='level_1'>
    <svg id='svg_1' width="1920" height="300"></svg>
</div>
<div id='level_0'>
    <svg id='svg_0' width="1920" height="300"></svg>
</div>
<div id='level_-1'>
    <svg id='svg__1' width="1920" height="300"></svg>
</div>
<div id='level_-2'>
<svg id='svg__2' width="1920" height="300"></svg>
</div>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.4.0/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyCSLoNuHVlqByDMr4YIFTpOrTsApowzphg",
      authDomain: "kraakdekrook.firebaseapp.com",
      databaseURL: "https://kraakkrook-c581e.firebaseio.com/ESP32",
      projectId: "kraakdekrook",
      storageBucket: "kraakdekrook.appspot.com",
      messagingSenderId: "818392028162"
    };
    firebase.initializeApp(config);
    var db = firebase.firestore();
    console.log(db);
  </script>
<script>

const sites = {};
const movedFuncs = {};

function init() {


  var voronoi = d3.voronoi();

  function redrawSite(site) {
    site
        .attr("cx", function(d) { return d[0]; })
        .attr("cy", function(d) { return d[1]; });
  }

  Object.keys(sites).forEach(function eachSite(level) {
    function moved(center) {
      console.log(center);
      sites[level][0] = center;
      redraw();
    }
    movedFuncs[level] = moved;
  
    function redraw() {
      var diagram = voronoi(sites[level]);
      triangle = triangle.data(diagram.triangles()), triangle.exit().remove();
      triangle = triangle.enter().append("path").merge(triangle).call(redrawtriangle);
      link = link.data(diagram.links()), link.exit().remove();
      link = link.enter().append("line").merge(link).call(redrawlink);
      site = site.data(sites[level]).call(redrawSite);
    }
  
    function redrawtriangle(triangle) {
      triangle
          .classed("primary", function(d) { return d[0] === sites[level][0] || d[1] === sites[level][0] || d[2] === sites[level][0]; })
          .attr("d", function(d) { return "M" + d.join("L") + "Z"; });
    }
  
    function redrawlink(link) {
      link
          .classed("primary", function(d) { return d.source === sites[level][0] || d.target === sites[level][0]; })
          .attr("x1", function(d) { return d.source[0]; })
          .attr("y1", function(d) { return d.source[1]; })
          .attr("x2", function(d) { return d.target[0]; })
          .attr("y2", function(d) { return d.target[1]; });
    }

    var svg = 
        d3.select(("#svg_" + level).replace('-', '_')),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var triangle = svg.append("g")
        .attr("class", "triangles")
      .selectAll("path")
      .data(voronoi.triangles(sites[level]))
      .enter().append("path")
        .call(redrawtriangle);

    var link = svg.append("g")
        .attr("class", "links")
      .selectAll("line")
      .data(voronoi.links(sites[level]))
      .enter().append("line")
        .call(redrawlink);

    var site = svg.append("g")
        .attr("class", "sites")
      .selectAll("circle")
      .data(sites[level])
      .enter().append("circle")
        .attr("r", function(d,i) {return i==0 ? 6 : 2.5 ;  })
        .call(redrawSite);
      // setInterval(getCoord(), 3000);
  });

  function getCoord(beacons){
    // This code gets the centroid of the three closest beacons to the device, e.g. a sort of fake location


    // var beacons = [{"beacons":[{"krookid":169,"rssi":-75},{"krookid":171,"rssi":-60},{"krookid":170,"rssi":-74},{"krookid":175,"rssi":-80}],"id":"michiel"}];

    var closest = beacons[0].beacons.sort((a, b) => b.rssi - a.rssi).slice(0, 3)
    var positions = locations;
    var level = positions[closest[0].krookid].level;

    var c1 = [positions[closest[0].krookid].x, positions[closest[0].krookid].y];
    var c2 = [positions[closest[1].krookid].x, positions[closest[1].krookid].y];
    var c3 = [positions[closest[2].krookid].x, positions[closest[2].krookid].y];

    var getCentroid = function (coord) {
      var center = coord.reduce(function (x,y) {
        return [x[0] + y[0]/coord.length, x[1] + y[1]/coord.length]
      }, [0,0])
      return center;
    }
    movedFuncs[level](getCentroid([c1, c2, c3]))

    console.log(getCentroid([c1, c2, c3]));
  }

  db.collection("scans").onSnapshot(querySnapshot => {
    var scans = []
    querySnapshot.forEach(doc => {
      scans.push(doc.data());
    })
    var beacons = scans;
    getCoord(beacons);
  });
}
var locations;
d3.json('locations-parsed.json', function(data) {
    locations = data;
    for (var i = 0; i < data.length; i++) {
        if (sites[data[i].level] == undefined) {
            sites[data[i].level] = []
        }
        sites[data[i].level].push([data[i].x, data[i].y]);
    }
    init();
});




</script>
